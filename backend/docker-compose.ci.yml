services:
    backend:
        build:
            context: .
            dockerfile: Dockerfile
        environment:
            APP_ENV: test
            XDEBUG_MODE: coverage
            DATABASE_URL: mysql://root:password@db:3306/testdb?charset=utf8mb4&serverVersion=mariadb-10.6.0
        command: php-fpm
        depends_on:
            - db
        networks:
            - ci

    db:
        image: mariadb:10.6
        environment:
            MYSQL_ROOT_PASSWORD: password
            MYSQL_DATABASE: testdb
        ports:
            - "3307:3306"
        networks:
            - ci
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-ppassword"]
            interval: 5s
            timeout: 5s
            retries: 10

networks:
    ci:
        driver: bridge
